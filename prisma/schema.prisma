generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int              @id @default(autoincrement())
  name             String
  email            String           @unique
  username         String?           @unique
  password         String
  role             Role
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  resetToken       String?
  resetTokenExpiry DateTime?
  invoices         Invoice[]
  myCompanies      MyCompany[]
  assignedTasks    Task[]           @relation("AssignedTasks")
  assignments      TaskAssignment[]

  @@map("user")
}

/// *
///  * ===========================
///  * CLIENT
///  * ===========================
model Client {
  id                Int                @id @default(autoincrement())
  name              String
  email             String?
  phone             String?
  gstNumber         String?
  createdAt         DateTime           @default(now())
  code              String             @unique
  addressLine1      String?
  addressLine2      String?
  city              String?
  pincode           String?
  state             String?
  stateCode         String?
  invoices          Invoice[]
  tasks             Task[]
  taskMasterClients TaskMasterClient[]
  // ðŸ”¥ GROUP RELATION
  clientGroupId     Int?
  clientGroup       ClientGroup? @relation(fields: [clientGroupId], references: [id], onDelete: SetNull)
  @@map("client")
}


model ClientGroup {
  id        Int      @id @default(autoincrement())
  name      String
  code      String   @unique
  createdAt DateTime @default(now())

  clients   Client[]

  @@map("client_group")
}

model MyCompany {
  id           Int       @id @default(autoincrement())
  ownerId      Int
  name         String
  gstin        String?   @unique
  pan          String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  pincode      String?
  phone        String?
  email        String?
  logoUrl      String?
  bankName     String?
  bankAccount  String?
  bankIfsc     String?
  bankBranch   String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  sealUrl      String?
  signatureUrl String?
  code         String    @unique
  invoices     Invoice[]
  owner        User      @relation(fields: [ownerId], references: [id])

  @@index([ownerId], map: "mycompany_ownerId_fkey")
  @@map("mycompany")
}

model Invoice {
  id                     Int               @id @default(autoincrement())
  clientId               Int
  createdAt              DateTime          @default(now())
  cgstAmount             Decimal           @default(0.00) @db.Decimal(12, 2)
  createdById            Int
  discount               Decimal           @default(0.00) @db.Decimal(12, 2)
  dueDate                DateTime?
  fromCompanyId          Int
  gstPercent             Decimal           @default(18.00) @db.Decimal(5, 2)
  igstAmount             Decimal           @default(0.00) @db.Decimal(12, 2)
  invoiceNumber          String            @unique
  isIntraState           Boolean           @default(true)
  isManualTotal          Boolean           @default(false)
  issueDate              DateTime          @default(now())
  notes                  String?
  placeOfSupply          String?
  pricingMode            GstPricingMode    @default(EXCLUSIVE)
  sgstAmount             Decimal           @default(0.00) @db.Decimal(12, 2)
  status                 InvoiceStatus     @default(DRAFT)
  subtotal               Decimal           @default(0.00) @db.Decimal(12, 2)
  total                  Decimal           @default(0.00) @db.Decimal(12, 2)
  updatedAt              DateTime          @updatedAt
  bankAccount            String?
  bankBranch             String?
  bankIfsc               String?
  bankName               String?
  clientAddress          String?
  clientCity             String?
  clientEmail            String?
  clientGstin            String?
  clientName             String?
  clientPhone            String?
  clientPincode          String?
  clientState            String?
  clientStateCode        String?
  companySealUrl         String?
  companySignatureUrl    String?
  fromCompanyAddress     String?
  fromCompanyEmail       String?
  fromCompanyGstin       String?
  fromCompanyName        String?
  fromCompanyPhone       String?
  fromCompanyState       String?
  fromCompanyStateCode   String?
  placeOfSupplyState     String?
  placeOfSupplyStateCode String?
  fromCompanyCity        String?
  client                 Client            @relation(fields: [clientId], references: [id])
  createdBy              User              @relation(fields: [createdById], references: [id])
  fromCompany            MyCompany         @relation(fields: [fromCompanyId], references: [id])
  emailLogs              InvoiceEmailLog[]
  items                  InvoiceItem[]
  sourceType String? // "MANUAL" | "TASKS"
  @@index([clientId], map: "invoice_clientId_fkey")
  @@index([createdById], map: "invoice_createdById_fkey")
  @@index([fromCompanyId], map: "invoice_fromCompanyId_fkey")
  @@map("invoice")
}

model InvoiceItem {
  id          Int      @id @default(autoincrement())
  invoiceId   Int
  taskId      Int?
  amount      Decimal  @default(0.00) @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  description String?
  quantity    Int      @default(1)
  title       String
  unitPrice   Decimal  @default(0.00) @db.Decimal(12, 2)
  hsnSac      String?
  unit        String?
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  task        Task?    @relation(fields: [taskId], references: [id])

  @@index([invoiceId], map: "invoiceitem_invoiceId_fkey")
  @@index([taskId], map: "invoiceitem_taskId_fkey")
  @@map("invoiceitem")
}

model InvoiceSequence {
  id        Int    @id @default(autoincrement())
  companyId Int
  fy        String
  month     String
  counter   Int

  @@unique([companyId, fy, month], name: "companyId_fy_month")
  @@map("invoicesequence")
}

model InvoiceEmailLog {
  id        Int      @id @default(autoincrement())
  invoiceId Int
  toEmail   String
  subject   String
  message   String?
  sentAt    DateTime @default(now())
  status    String
  error     String?
  createdAt DateTime @default(now())
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId], map: "invoiceemaillog_invoiceId_fkey")
  @@map("invoiceemaillog")
}

/// *
///  * ===========================
///  * TASK CATEGORY (NEW)
///  * ===========================
model TaskCategory {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  description String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  tasks       Task[]
  taskMasters TaskMaster[]

  @@map("taskcategory")
}

/// *
///  * ===========================
///  * TASK MASTER (NEW)
///  * ===========================
model TaskMaster {
  id            Int                @id @default(autoincrement())
  title         String
  description   String?
  categoryId    Int
  frequency     FrequencyType
  interval      Int?
  financialYear String?
  defaultDueDay Int?
  startDate     DateTime
  endDate       DateTime?
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  tasks         Task[]
  category      TaskCategory       @relation(fields: [categoryId], references: [id])
  clients       TaskMasterClient[]
  isBillable    Boolean  @default(true) 

  hsnSac       String?        // e.g. "9983"
  gstRate      Decimal? @db.Decimal(5,2) // e.g. 18.00
  unitLabel    String?        // "Return", "Month", "Service"


  @@index([categoryId])
  @@index([isActive])
  @@map("taskmaster")
}

/// *
///  * ===========================
///  * TASK MASTER â†” CLIENT (NEW)
///  * ===========================
model TaskMasterClient {
  id           Int        @id @default(autoincrement())
  taskMasterId Int
  clientId     Int
  customDueDay Int?
  startDate    DateTime?
  endDate      DateTime?
  isActive     Boolean    @default(true)
  client       Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  taskMaster   TaskMaster @relation(fields: [taskMasterId], references: [id], onDelete: Cascade)

  @@unique([taskMasterId, clientId])
  @@index([clientId])
  @@index([taskMasterId])
  @@index([isActive])
  @@map("taskmasterclient")
}


model Task {
  id               Int              @id @default(autoincrement())
  title            String
  description      String?
  /// *
  ///    * ===========================
  ///    * CLIENT & STATUS
  ///    * ===========================
  clientId         Int
  status           TaskStatus       @default(PENDING)
  interval         Int?
  /// *
  ///    * ===========================
  ///    * EXECUTION TRACKING
  ///    * ===========================
  dueDate          DateTime?
  completedAt      DateTime?
  createdAt        DateTime         @default(now())
    // ðŸ”¥ SNAPSHOT FROM MASTER
  hsnSac       String?
  gstRate      Decimal? @db.Decimal(5,2)
  unitLabel    String?
  /// *
  ///    * ===========================
  ///    * SOFT DELETE
  ///    * ===========================
  deletedAt        DateTime?
  /// *
  ///    * ===========================
  ///    * NEW: CURRENT ASSIGNEE (fast filter)
  ///    * ===========================
  assignedToUserId Int?
  categoryId       Int?
  periodEnd        DateTime?
  /// *
  ///    * ===========================
  ///    * NEW: PERIOD (for generated monthly/quarterly/yearly tasks)
  ///    * ===========================
  periodStart      DateTime?
  /// *
  ///    * ===========================
  ///    * NEW: MASTER LINK + CATEGORY SNAPSHOT
  ///    * ===========================
  taskMasterId     Int?
  isBillable      Boolean @default(true)
  periodKey        String?
  invoiceItems     InvoiceItem[]
  assignedToUser   User?            @relation("AssignedTasks", fields: [assignedToUserId], references: [id])
  category         TaskCategory?    @relation(fields: [categoryId], references: [id])
  client           Client           @relation(fields: [clientId], references: [id])
  taskMaster       TaskMaster?      @relation(fields: [taskMasterId], references: [id])
  assignments      TaskAssignment[]

  @@index([clientId])
  @@index([deletedAt])
  @@index([taskMasterId])
  @@index([categoryId])
  @@index([assignedToUserId])
  @@index([periodStart])
  @@index([taskMasterId, clientId, periodKey])
  @@map("task")
}

/// *
///  * ===========================
///  * TASK ASSIGNMENT (Audit Trail)
///  * ===========================
model TaskAssignment {
  id         Int      @id @default(autoincrement())
  taskId     Int
  userId     Int
  assignedAt DateTime @default(now())
  task       Task     @relation(fields: [taskId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([taskId, userId])
  @@index([userId], map: "taskassignment_userId_fkey")
  @@map("taskassignment")
}

/// *
///  * ===========================
///  * ENUMS
///  * ===========================
enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

enum GstPricingMode {
  EXCLUSIVE
  INCLUSIVE
}

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
  EXECUTIVE
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
  INVOICED
}

enum FrequencyType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  EVENT_BASED
}
